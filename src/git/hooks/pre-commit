#!/bin/bash

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

if ! command -v trufflehog &> /dev/null; then
    echo -e "${YELLOW}TruffleHog not installed. Skipping secrets check.${NC}"
    echo -e "${YELLOW}Install with: brew install trufflehog${NC}"
    exit 0
fi

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null || true)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        mkdir -p "$TEMP_DIR/$(dirname "$file")"
        git show ":$file" > "$TEMP_DIR/$file" 2>/dev/null || true
    fi
done

output=$(trufflehog filesystem "$TEMP_DIR" --no-update --no-verification --fail 2>&1) || exit_code=$?

if [ "${exit_code:-0}" -eq 183 ]; then
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘           ğŸ” SECRETS DETECTED BY TRUFFLEHOG!               â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    echo "$output" | sed "s|$TEMP_DIR/||g"
    echo
    echo -e "${YELLOW}Please remove the secrets before committing.${NC}"
    echo -e "${YELLOW}If these are false positives, you can bypass this check with:${NC}"
    echo -e "  ${GREEN}git commit --no-verify${NC}"
    echo
    exit 1
fi

exit 0
